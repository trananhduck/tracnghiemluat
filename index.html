<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cailozhuhong</title>
    <style>
      :root {
        --primary: #2563eb;
        --success: #16a34a;
        --danger: #dc2626;
        --warning: #ca8a04;
        --bg: #f3f4f6;
        --sidebar-width: 260px;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: "Segoe UI", sans-serif;
      }
      body {
        display: flex;
        height: 100vh;
        background: var(--bg);
        overflow: hidden;
      }

      /* --- SIDEBAR TR√ÅI: LIST ƒê·ªÄ --- */
      aside.left-sidebar {
        width: var(--sidebar-width);
        background: #1e293b;
        color: white;
        display: flex;
        flex-direction: column;
        border-right: 1px solid #334155;
      }
      .sidebar-header {
        padding: 20px;
        font-size: 1.2rem;
        font-weight: bold;
        border-bottom: 1px solid #334155;
      }
      .exam-list {
        overflow-y: auto;
        flex: 1;
      }
      .exam-item {
        padding: 15px 20px;
        cursor: pointer;
        transition: 0.2s;
        border-bottom: 1px solid #334155;
      }
      .exam-item:hover {
        background: #334155;
      }
      .exam-item.active {
        background: var(--primary);
        border-left: 4px solid #60a5fa;
      }

      /* --- MAIN CONTENT --- */
      main {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 20px;
        overflow-y: auto;
        position: relative;
      }

      /* Setup Screen */
      .setup-screen {
        background: white;
        padding: 40px;
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        max-width: 600px;
        margin: auto;
        text-align: center;
      }

      /* Quiz Header */
      .quiz-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: white;
        padding: 15px 25px;
        border-radius: 10px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }
      .timer {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--danger);
        font-family: monospace;
      }

      /* Question Card */
      .question-card {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      .q-text {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 25px;
        color: #1f2937;
      }

      /* Options */
      .options-grid {
        display: grid;
        gap: 15px;
      }
      .option-btn {
        padding: 15px 20px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        background: white;
        text-align: left;
        cursor: pointer;
        transition: 0.2s;
        font-size: 1rem;
      }
      .option-btn:hover:not([disabled]) {
        border-color: var(--primary);
        background: #eff6ff;
      }

      /* States */
      .option-btn.correct {
        background: #dcfce7;
        border-color: var(--success);
        color: #14532d;
      }
      .option-btn.wrong {
        background: #fee2e2;
        border-color: var(--danger);
        color: #7f1d1d;
      }
      .option-btn.selected {
        border-color: var(--primary);
        background: #eff6ff;
      }

      /* Rationale */
      .rationale {
        margin-top: 20px;
        padding: 15px;
        background: #f0fdf4;
        border-left: 4px solid var(--success);
        display: none;
        animation: fadeIn 0.3s ease;
      }

      /* Controls */
      .controls {
        margin-top: auto;
        padding-top: 20px;
        display: flex;
        gap: 10px;
        justify-content: space-between;
      }
      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        color: white;
      }
      .btn-nav {
        background: var(--primary);
      }
      .btn-flag {
        background: var(--warning);
        color: #fff;
      }
      .btn-submit {
        background: var(--success);
      }
      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* --- SIDEBAR PH·∫¢I: PALETTE --- */
      aside.right-sidebar {
        width: 280px;
        background: white;
        border-left: 1px solid #e5e7eb;
        display: flex;
        flex-direction: column;
        padding: 15px;
      }
      .palette-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 8px;
        margin-top: 15px;
        overflow-y: auto;
      }
      .p-item {
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        position: relative;
      }
      .p-item.active {
        border: 2px solid var(--primary);
        font-weight: bold;
      }
      .p-item.is-correct {
        background: var(--success);
        color: white;
        border: none;
      }
      .p-item.is-wrong {
        background: var(--danger);
        color: white;
        border: none;
      }
      .p-item.is-flagged::after {
        content: "üö©";
        position: absolute;
        top: -5px;
        right: -5px;
        font-size: 10px;
      }

      /* --- MODAL POPUP --- */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        display: none;
        align-items: center;
        justify-content: center;
      }
      .modal-box {
        background: white;
        padding: 25px;
        border-radius: 10px;
        width: 400px;
        text-align: center;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      }
      .modal-buttons {
        margin-top: 20px;
        display: flex;
        justify-content: center;
        gap: 10px;
      }
      .btn-cancel {
        background: #94a3b8;
      }
      .btn-confirm {
        background: var(--danger);
      }

      .hidden {
        display: none !important;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(5px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @media (max-width: 900px) {
        body {
          flex-direction: column;
          overflow: auto;
        }
        aside.left-sidebar,
        aside.right-sidebar {
          width: 100%;
          height: auto;
          max-height: 200px;
        }
        main {
          height: auto;
          min-height: 600px;
        }
      }
    </style>
  </head>
  <body>
    <aside class="left-sidebar">
      <div class="sidebar-header">Kho ƒê·ªÅ Thi</div>
      <div class="exam-list" id="exam-list">
        <p style="padding: 15px; color: #94a3b8; text-align: center">
          ƒêang t·∫£i d·ªØ li·ªáu...
        </p>
      </div>
    </aside>

    <main>
      <div id="setup-screen" class="setup-screen hidden">
        <h2 id="setup-title" style="margin-bottom: 20px; color: var(--primary)">
          Ch·ªçn ƒê·ªÅ Thi
        </h2>
        <p style="margin-bottom: 20px; color: #64748b">
          Vui l√≤ng ch·ªçn th·ªùi gian l√†m b√†i:
        </p>
        <select
          id="time-select"
          style="
            padding: 10px;
            width: 200px;
            border-radius: 5px;
            margin-bottom: 20px;
          "
        >
          <option value="15">15 Ph√∫t</option>
          <option value="30">30 Ph√∫t</option>
          <option value="45">45 Ph√∫t</option>
          <option value="60" selected>60 Ph√∫t</option>
          <option value="0">Kh√¥ng gi·ªõi h·∫°n</option>
        </select>
        <br />
        <button class="btn btn-nav" onclick="initQuiz()">
          B·∫Øt ƒê·∫ßu L√†m B√†i
        </button>
        <div id="resume-btn-container" class="hidden" style="margin-top: 10px">
          <p style="color: var(--warning); margin-bottom: 5px">
            Ph√°t hi·ªán b√†i l√†m ch∆∞a xong!
          </p>
          <button class="btn btn-flag" onclick="resumeQuiz()">
            Ti·∫øp t·ª•c l√†m b√†i c≈©
          </button>
        </div>
      </div>

      <div
        id="quiz-interface"
        class="hidden"
        style="display: flex; flex-direction: column; height: 100%"
      >
        <div class="quiz-header">
          <div>
            <h3 id="current-exam-title">ƒê·ªÅ thi</h3>
            <small>Ti·∫øn ƒë·ªô: <span id="progress-text">0/60</span></small>
          </div>
          <div class="timer" id="timer">00:00</div>
        </div>

        <div class="question-card">
          <div id="question-content">
            <p class="q-text" id="q-text">Loading...</p>
            <div class="options-grid" id="q-options"></div>
            <div class="rationale" id="q-rationale"></div>
          </div>

          <div class="controls">
            <button class="btn btn-nav" id="btn-prev" onclick="navStep(-1)">
              ‚ùÆ C√¢u tr∆∞·ªõc
            </button>
            <div>
              <button class="btn btn-flag" onclick="toggleFlag()">
                üö© ƒê·∫∑t c·ªù
              </button>
            </div>
            <button class="btn btn-nav" id="btn-next" onclick="navStep(1)">
              C√¢u sau ‚ùØ
            </button>
          </div>
          <div style="text-align: right; margin-top: 15px">
            <button class="btn btn-submit" onclick="confirmAction('submit')">
              N·ªôp B√†i & Xem K·∫øt Qu·∫£
            </button>
          </div>
        </div>
      </div>

      <div id="result-screen" class="setup-screen hidden">
        <h1 style="color: var(--success)">K·∫øt Qu·∫£</h1>
        <h2 id="final-score" style="font-size: 3rem; margin: 20px 0">0/60</h2>
        <div
          id="analysis-box"
          style="
            text-align: left;
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
          "
        ></div>
        <button class="btn btn-nav" onclick="confirmAction('reset')">
          L√†m ƒê·ªÅ Kh√°c
        </button>
      </div>
    </main>

    <aside class="right-sidebar">
      <h4>Danh s√°ch c√¢u h·ªèi</h4>
      <div style="font-size: 12px; margin: 10px 0; color: #64748b">
        <span style="color: var(--success)">‚ñ†</span> ƒê√∫ng &nbsp;
        <span style="color: var(--danger)">‚ñ†</span> Sai &nbsp;
        <span style="color: var(--warning)">üö©</span> C·ªù
      </div>
      <div class="palette-grid" id="palette"></div>
    </aside>

    <div id="modal" class="modal-overlay">
      <div class="modal-box">
        <h3 id="modal-title">X√°c nh·∫≠n</h3>
        <p id="modal-msg" style="margin: 15px 0; color: #475569">
          B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën th·ª±c hi·ªán?
        </p>
        <div class="modal-buttons">
          <button class="btn btn-cancel" onclick="closeModal()">H·ªßy</button>
          <button class="btn btn-confirm" id="modal-confirm-btn">ƒê·ªìng √Ω</button>
        </div>
      </div>
    </div>

    <script>
      // --- 1. BI·∫æN DATA TO√ÄN C·ª§C ---
      let DB = [];

      // --- 2. STATE MANAGEMENT ---
      let state = {
        examId: null,
        currentQIdx: 0,
        answers: {},
        flags: [],
        timeLeft: 0,
        isFinished: false,
      };
      let timerInterval;

      // --- 3. LOAD D·ªÆ LI·ªÜU T·ª™ FILE JSON ---
      async function loadDataAndInit() {
        try {
          // Fetch file json ƒë·ªìng c·∫•p
          const response = await fetch("data.json");
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          DB = await response.json();

          // Sau khi c√≥ d·ªØ li·ªáu m·ªõi render list ƒë·ªÅ
          renderExamList();

          // M·∫∑c ƒë·ªãnh hi·ªÉn th·ªã m√†n h√¨nh setup n·∫øu ch∆∞a ch·ªçn
          if (state.examId === null) {
            document.getElementById("setup-screen").classList.add("hidden"); // ·∫®n t·∫°m th·ªùi, user click v√†o list m·ªõi hi·ªán
          }

          checkLocalStorage();
        } catch (error) {
          console.error("L·ªói t·∫£i data.json:", error);
          document.getElementById("exam-list").innerHTML = `
                    <div style="padding:15px; color: #ef4444; text-align: center;">
                        <strong>Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu!</strong><br><br>
                        N·∫øu b·∫°n ƒëang m·ªü tr·ª±c ti·∫øp file HTML (file://), h√£y ch·∫°y qua Local Server ho·∫∑c Live Server.<br>
                        N·∫øu ƒë√£ l√™n GitHub Pages, h√£y ki·ªÉm tra t√™n file 'data.json' c√≥ ƒë√∫ng kh√¥ng.
                    </div>
                `;
        }
      }

      window.onload = loadDataAndInit;

      // Ch·∫∑n reload/close tab v√¥ t√¨nh
      window.onbeforeunload = (e) => {
        if (state.examId !== null && !state.isFinished) {
          return "B·∫°n ƒëang l√†m b√†i, d·ªØ li·ªáu c√≥ th·ªÉ b·ªã m·∫•t n·∫øu kh√¥ng l∆∞u?";
        }
      };

      function renderExamList() {
        const list = document.getElementById("exam-list");
        list.innerHTML = "";

        if (DB.length === 0) {
          list.innerHTML =
            '<p style="padding:15px; text-align:center;">Kh√¥ng c√≥ ƒë·ªÅ thi n√†o.</p>';
          return;
        }

        DB.forEach((exam, idx) => {
          const div = document.createElement("div");
          div.className = "exam-item";
          div.innerText = exam.title;
          div.onclick = () => trySelectExam(idx);
          div.id = `exam-btn-${idx}`;
          list.appendChild(div);
        });
      }

      // --- 4. CORE FUNCTIONS ---

      function checkLocalStorage() {
        const saved = localStorage.getItem("quiz_state");
        if (saved) {
          const parsed = JSON.parse(saved);
          if (!parsed.isFinished) {
            document
              .getElementById("resume-btn-container")
              .classList.remove("hidden");
            // N·∫øu c√≥ save, c√≥ th·ªÉ hi·ªÉn th·ªã lu√¥n m√†n h√¨nh setup c·ªßa ƒë·ªÅ ƒë√≥
            document.getElementById("setup-screen").classList.remove("hidden");
          }
        }
      }

      function trySelectExam(idx) {
        if (
          state.examId !== null &&
          !state.isFinished &&
          state.examId !== idx
        ) {
          showModal(
            "Chuy·ªÉn ƒë·ªÅ thi?",
            "B·∫°n ƒëang l√†m d·ªü b√†i n√†y. N·∫øu chuy·ªÉn, ti·∫øn ƒë·ªô hi·ªán t·∫°i s·∫Ω b·ªã m·∫•t.",
            () => {
              selectExam(idx);
            },
          );
        } else {
          selectExam(idx);
        }
      }

      function selectExam(idx) {
        localStorage.removeItem("quiz_state");
        state = {
          examId: idx,
          currentQIdx: 0,
          answers: {},
          flags: [],
          timeLeft: 0,
          isFinished: false,
        };

        // Highlight sidebar
        document
          .querySelectorAll(".exam-item")
          .forEach((el) => el.classList.remove("active"));
        const btn = document.getElementById(`exam-btn-${idx}`);
        if (btn) btn.classList.add("active");

        // Show setup screen
        document.getElementById("setup-screen").classList.remove("hidden");
        document.getElementById("quiz-interface").classList.add("hidden");
        document.getElementById("result-screen").classList.add("hidden");
        document.getElementById("setup-title").innerText = DB[idx].title;
        document.getElementById("resume-btn-container").classList.add("hidden");
      }

      function initQuiz() {
        const minutes = parseInt(document.getElementById("time-select").value);
        state.timeLeft = minutes * 60;
        startEngine();
      }

      function resumeQuiz() {
        const saved = localStorage.getItem("quiz_state");
        if (saved) {
          state = JSON.parse(saved);

          // Highlight l·∫°i ƒë·ªÅ c≈©
          document
            .querySelectorAll(".exam-item")
            .forEach((el) => el.classList.remove("active"));
          const btn = document.getElementById(`exam-btn-${state.examId}`);
          if (btn) btn.classList.add("active");

          startEngine();
        }
      }

      function startEngine() {
        document.getElementById("setup-screen").classList.add("hidden");
        document.getElementById("result-screen").classList.add("hidden");
        document.getElementById("quiz-interface").classList.remove("hidden");

        const currentExam = DB[state.examId];
        document.getElementById("current-exam-title").innerText =
          currentExam.title;

        renderPalette();
        loadQuestion(state.currentQIdx);
        startTimer();
      }

      // --- 5. LOGIC B√ÄI THI ---

      function loadQuestion(idx) {
        if (idx < 0 || idx >= DB[state.examId].questions.length) return;
        state.currentQIdx = idx;

        const q = DB[state.examId].questions[idx];
        document.getElementById("q-text").innerText =
          `C√¢u ${idx + 1}: ${q.question}`;
        document.getElementById("progress-text").innerText =
          `${idx + 1}/${DB[state.examId].questions.length}`;

        // Options
        const optDiv = document.getElementById("q-options");
        optDiv.innerHTML = "";

        const userAns = state.answers[idx];

        q.options.forEach((optText, optIdx) => {
          const btn = document.createElement("button");
          btn.className = "option-btn";
          btn.innerText = optText;

          if (userAns !== undefined) {
            btn.disabled = true;
            if (optIdx === q.correct) btn.classList.add("correct");
            if (optIdx === userAns && optIdx !== q.correct)
              btn.classList.add("wrong");
          } else {
            btn.onclick = () => handleAnswer(idx, optIdx);
          }
          optDiv.appendChild(btn);
        });

        // Rationale
        const ratDiv = document.getElementById("q-rationale");
        if (userAns !== undefined) {
          ratDiv.style.display = "block";
          ratDiv.innerHTML = `<strong>Gi·∫£i th√≠ch:</strong> ${q.rationale}`;
        } else {
          ratDiv.style.display = "none";
        }

        document.getElementById("btn-prev").disabled = idx === 0;
        document.getElementById("btn-next").disabled =
          idx === DB[state.examId].questions.length - 1;

        updatePaletteUI();
        saveState();
      }

      function handleAnswer(qIdx, ansIdx) {
        state.answers[qIdx] = ansIdx;
        loadQuestion(qIdx);
        updatePaletteUI();
        saveState();
      }

      function toggleFlag() {
        const idx = state.currentQIdx;
        if (state.flags.includes(idx)) {
          state.flags = state.flags.filter((i) => i !== idx);
        } else {
          state.flags.push(idx);
        }
        updatePaletteUI();
        saveState();
      }

      function navStep(step) {
        loadQuestion(state.currentQIdx + step);
      }

      // --- 6. PALETTE & HELPER ---
      function renderPalette() {
        const grid = document.getElementById("palette");
        grid.innerHTML = "";
        const total = DB[state.examId].questions.length;
        for (let i = 0; i < total; i++) {
          const item = document.createElement("div");
          item.className = "p-item";
          item.innerText = i + 1;
          item.id = `p-${i}`;
          item.onclick = () => loadQuestion(i);
          grid.appendChild(item);
        }
        updatePaletteUI();
      }

      function updatePaletteUI() {
        const questions = DB[state.examId].questions;
        questions.forEach((q, i) => {
          const el = document.getElementById(`p-${i}`);
          if (!el) return;

          el.className = "p-item";
          if (i === state.currentQIdx) el.classList.add("active");
          if (state.flags.includes(i)) el.classList.add("is-flagged");

          if (state.answers[i] !== undefined) {
            const isCorrect = state.answers[i] === q.correct;
            el.classList.add(isCorrect ? "is-correct" : "is-wrong");
          }
        });
      }

      // --- 7. TIMER & SAVE ---
      function startTimer() {
        clearInterval(timerInterval);
        if (state.timeLeft <= 0) {
          document.getElementById("timer").innerText = "‚àû";
          return;
        }

        timerInterval = setInterval(() => {
          state.timeLeft--;
          const m = Math.floor(state.timeLeft / 60)
            .toString()
            .padStart(2, "0");
          const s = (state.timeLeft % 60).toString().padStart(2, "0");
          document.getElementById("timer").innerText = `${m}:${s}`;

          saveState();

          if (state.timeLeft <= 0) {
            clearInterval(timerInterval);
            alert("H·∫øt gi·ªù l√†m b√†i!");
            finishExam();
          }
        }, 1000);
      }

      function saveState() {
        localStorage.setItem("quiz_state", JSON.stringify(state));
      }

      // --- 8. FINISH & ANALYSIS ---
      function finishExam() {
        clearInterval(timerInterval);
        state.isFinished = true;
        localStorage.removeItem("quiz_state");

        let score = 0;
        let topicAnalysis = {};

        const questions = DB[state.examId].questions;
        questions.forEach((q, idx) => {
          if (!topicAnalysis[q.topic])
            topicAnalysis[q.topic] = { total: 0, wrong: 0 };
          topicAnalysis[q.topic].total++;

          if (state.answers[idx] === q.correct) {
            score++;
          } else {
            topicAnalysis[q.topic].wrong++;
          }
        });

        document.getElementById("quiz-interface").classList.add("hidden");
        document.getElementById("result-screen").classList.remove("hidden");
        document.getElementById("final-score").innerText =
          `${score}/${questions.length}`;

        let html = `<h3>Ph√¢n t√≠ch chi ti·∫øt:</h3><ul style="margin-top:10px; padding-left:20px;">`;
        let hasWeakness = false;

        for (const [topic, stat] of Object.entries(topicAnalysis)) {
          if (stat.wrong > 0) {
            hasWeakness = true;
            const percent = Math.round((stat.wrong / stat.total) * 100);
            html += `<li style="margin-bottom:8px;">
                        <strong>${topic}</strong>: Sai ${stat.wrong}/${stat.total} c√¢u (${percent}%). 
                        <span style="color:var(--danger)">C·∫ßn √¥n t·∫≠p th√™m.</span>
                    </li>`;
          }
        }
        if (!hasWeakness)
          html += `<li style="color:var(--success)">Tuy·ªát v·ªùi! B·∫°n kh√¥ng sai c√¢u n√†o theo ch·ªß ƒë·ªÅ.</li>`;
        html += `</ul>`;

        document.getElementById("analysis-box").innerHTML = html;
      }

      // --- 9. MODAL & CONFIRMATION ---
      let confirmCallback = null;

      function showModal(title, msg, callback) {
        document.getElementById("modal-title").innerText = title;
        document.getElementById("modal-msg").innerText = msg;
        document.getElementById("modal").style.display = "flex";
        confirmCallback = callback;
      }

      function closeModal() {
        document.getElementById("modal").style.display = "none";
        confirmCallback = null;
      }

      document.getElementById("modal-confirm-btn").onclick = () => {
        if (confirmCallback) confirmCallback();
        closeModal();
      };

      function confirmAction(action) {
        if (action === "submit") {
          const unanswered =
            DB[state.examId].questions.length -
            Object.keys(state.answers).length;
          let msg = "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën n·ªôp b√†i?";
          if (unanswered > 0) msg += ` B·∫°n c√≤n ${unanswered} c√¢u ch∆∞a l√†m.`;

          showModal("N·ªôp b√†i thi", msg, finishExam);
        } else if (action === "reset") {
          location.reload();
        }
      }
    </script>
  </body>
</html>
