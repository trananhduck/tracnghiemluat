<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>H·ªá Th·ªëng Tr·∫Øc Nghi·ªám Pro</title>
    <style>
      :root {
        --primary: #2563eb;
        --success: #16a34a;
        --danger: #dc2626;
        --warning: #ca8a04;
        --bg: #f3f4f6;
        --sidebar-width: 260px;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: "Segoe UI", sans-serif;
      }
      body {
        display: flex;
        height: 100vh;
        background: var(--bg);
        overflow: hidden;
      }

      /* SIDEBAR */
      aside.left-sidebar {
        width: var(--sidebar-width);
        background: #1e293b;
        color: white;
        display: flex;
        flex-direction: column;
        border-right: 1px solid #334155;
      }
      .sidebar-header {
        padding: 20px;
        font-size: 1.2rem;
        font-weight: bold;
        border-bottom: 1px solid #334155;
      }
      .exam-list {
        overflow-y: auto;
        flex: 1;
      }
      .exam-item {
        padding: 15px 20px;
        cursor: pointer;
        transition: 0.2s;
        border-bottom: 1px solid #334155;
      }
      .exam-item:hover {
        background: #334155;
      }
      .exam-item.active {
        background: var(--primary);
        border-left: 4px solid #60a5fa;
      }

      /* N√∫t t·∫°o ƒë·ªÅ ng·∫´u nhi√™n ·ªü sidebar */
      .random-btn-container {
        padding: 15px;
        border-top: 1px solid #334155;
        text-align: center;
      }
      .btn-random {
        width: 100%;
        padding: 10px;
        background: #8b5cf6; /* M√†u t√≠m */
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        transition: 0.2s;
      }
      .btn-random:hover {
        background: #7c3aed;
      }

      /* MAIN CONTENT */
      main {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 20px;
        overflow-y: auto;
        position: relative;
      }

      /* SCREENS */
      .setup-screen {
        background: white;
        padding: 40px;
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        max-width: 600px;
        margin: auto;
        text-align: center;
      }

      .quiz-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: white;
        padding: 15px 25px;
        border-radius: 10px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }
      .timer {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--danger);
        font-family: monospace;
      }
      .timer.finished {
        color: var(--success);
      }

      .question-card {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      .q-text {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 25px;
        color: #1f2937;
      }

      /* OPTIONS */
      .options-grid {
        display: grid;
        gap: 15px;
      }
      .option-btn {
        padding: 15px 20px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        background: white;
        text-align: left;
        cursor: pointer;
        transition: 0.2s;
        font-size: 1rem;
      }
      .option-btn:hover:not([disabled]) {
        border-color: var(--primary);
        background: #eff6ff;
      }

      /* States - Immediate Feedback */
      .option-btn.correct {
        background: #dcfce7;
        border-color: var(--success);
        color: #14532d;
        font-weight: bold;
      }
      .option-btn.wrong {
        background: #fee2e2;
        border-color: var(--danger);
        color: #7f1d1d;
      }
      .option-btn:disabled {
        opacity: 0.9;
        cursor: not-allowed;
      }

      /* RATIONALE */
      .rationale {
        margin-top: 20px;
        padding: 15px;
        background: #f0fdf4;
        border-left: 4px solid var(--success);
        display: none;
        animation: fadeIn 0.3s ease;
      }

      /* CONTROLS */
      .controls {
        margin-top: auto;
        padding-top: 20px;
        display: flex;
        gap: 10px;
        justify-content: space-between;
      }
      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        color: white;
      }
      .btn-nav {
        background: var(--primary);
      }
      .btn-flag {
        background: var(--warning);
        color: #fff;
      }
      .btn-submit {
        background: var(--success);
      }
      .btn-review {
        background: #64748b;
      }
      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* PALETTE */
      aside.right-sidebar {
        width: 280px;
        background: white;
        border-left: 1px solid #e5e7eb;
        display: flex;
        flex-direction: column;
        padding: 15px;
      }
      .palette-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 8px;
        margin-top: 15px;
        overflow-y: auto;
      }
      .p-item {
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        position: relative;
      }
      .p-item.active {
        border: 2px solid var(--primary);
        font-weight: bold;
      }
      .p-item.is-correct {
        background: var(--success);
        color: white;
        border: none;
      }
      .p-item.is-wrong {
        background: var(--danger);
        color: white;
        border: none;
      }
      .p-item.is-flagged::after {
        content: "üö©";
        position: absolute;
        top: -5px;
        right: -5px;
        font-size: 10px;
      }

      /* MODAL */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        display: none;
        align-items: center;
        justify-content: center;
      }
      .modal-box {
        background: white;
        padding: 25px;
        border-radius: 10px;
        width: 400px;
        text-align: center;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      }
      .modal-buttons {
        margin-top: 20px;
        display: flex;
        justify-content: center;
        gap: 10px;
      }
      .btn-cancel {
        background: #94a3b8;
      }
      .btn-confirm {
        background: var(--danger);
      }

      .hidden {
        display: none !important;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(5px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @media (max-width: 900px) {
        body {
          flex-direction: column;
          overflow: auto;
        }
        aside.left-sidebar,
        aside.right-sidebar {
          width: 100%;
          height: auto;
          max-height: 200px;
        }
        main {
          height: auto;
          min-height: 600px;
        }
      }
    </style>
  </head>
  <body>
    <aside class="left-sidebar">
      <div class="sidebar-header">Kho ƒê·ªÅ Thi</div>

      <div class="random-btn-container">
        <button class="btn-random" onclick="createCustomExam()">
          üé≤ T·∫°o ƒê·ªÅ Ng·∫´u Nhi√™n (60 c√¢u)
        </button>
      </div>

      <div class="exam-list" id="exam-list">
        <p style="padding: 15px; color: #94a3b8; text-align: center">
          ƒêang t·∫£i d·ªØ li·ªáu...
        </p>
      </div>
    </aside>

    <main>
      <div id="setup-screen" class="setup-screen hidden">
        <h2 id="setup-title" style="margin-bottom: 20px; color: var(--primary)">
          Ch·ªçn ƒê·ªÅ Thi
        </h2>
        <p style="margin-bottom: 20px; color: #64748b">
          Vui l√≤ng ch·ªçn th·ªùi gian l√†m b√†i:
        </p>
        <select
          id="time-select"
          style="
            padding: 10px;
            width: 200px;
            border-radius: 5px;
            margin-bottom: 20px;
          "
        >
          <option value="15">15 Ph√∫t</option>
          <option value="30">30 Ph√∫t</option>
          <option value="45">45 Ph√∫t</option>
          <option value="60" selected>60 Ph√∫t</option>
          <option value="0">Kh√¥ng gi·ªõi h·∫°n</option>
        </select>
        <br />
        <button class="btn btn-nav" onclick="initQuiz()">
          B·∫Øt ƒê·∫ßu L√†m B√†i
        </button>
        <div id="resume-btn-container" class="hidden" style="margin-top: 10px">
          <p style="color: var(--warning); margin-bottom: 5px">
            Ph√°t hi·ªán b√†i l√†m ch∆∞a xong!
          </p>
          <button class="btn btn-flag" onclick="resumeQuiz()">
            Ti·∫øp t·ª•c l√†m b√†i c≈©
          </button>
        </div>
      </div>

      <div
        id="quiz-interface"
        class="hidden"
        style="display: flex; flex-direction: column; height: 100%"
      >
        <div class="quiz-header">
          <div>
            <h3 id="current-exam-title">ƒê·ªÅ thi</h3>
            <small>Ti·∫øn ƒë·ªô: <span id="progress-text">0/60</span></small>
          </div>
          <div class="timer" id="timer">00:00</div>
        </div>

        <div class="question-card">
          <div id="question-content">
            <p class="q-text" id="q-text">Loading...</p>
            <div class="options-grid" id="q-options"></div>
            <div class="rationale" id="q-rationale"></div>
          </div>

          <div class="controls">
            <button class="btn btn-nav" id="btn-prev" onclick="navStep(-1)">
              ‚ùÆ C√¢u tr∆∞·ªõc
            </button>
            <div>
              <button class="btn btn-flag" onclick="toggleFlag()" id="btn-flag">
                üö© ƒê·∫∑t c·ªù
              </button>
            </div>
            <button class="btn btn-nav" id="btn-next" onclick="navStep(1)">
              C√¢u sau ‚ùØ
            </button>
          </div>
          <div style="text-align: right; margin-top: 15px">
            <button
              class="btn btn-submit"
              id="btn-submit"
              onclick="confirmAction('submit')"
            >
              N·ªôp B√†i & Xem K·∫øt Qu·∫£
            </button>
            <button
              class="btn btn-review hidden"
              id="btn-exit-review"
              onclick="exitReviewMode()"
            >
              Tho√°t Xem L·∫°i
            </button>
          </div>
        </div>
      </div>

      <div id="result-screen" class="setup-screen hidden">
        <h1 style="color: var(--success)">K·∫øt Qu·∫£</h1>
        <h2 id="final-score" style="font-size: 3rem; margin: 20px 0">0/60</h2>
        <div
          id="analysis-box"
          style="
            text-align: left;
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
          "
        ></div>
        <div style="display: flex; gap: 10px; justify-content: center">
          <button class="btn btn-review" onclick="enterReviewMode()">
            üîç Xem L·∫°i B√†i L√†m
          </button>
          <button class="btn btn-nav" onclick="confirmAction('reset')">
            L√†m ƒê·ªÅ Kh√°c
          </button>
        </div>
      </div>
    </main>

    <aside class="right-sidebar">
      <h4>Danh s√°ch c√¢u h·ªèi</h4>
      <div style="font-size: 12px; margin: 10px 0; color: #64748b">
        <span style="color: var(--success)">‚ñ†</span> ƒê√∫ng &nbsp;
        <span style="color: var(--danger)">‚ñ†</span> Sai &nbsp;
        <span style="color: var(--warning)">üö©</span> C·ªù
      </div>
      <div class="palette-grid" id="palette"></div>
    </aside>

    <div id="modal" class="modal-overlay">
      <div class="modal-box">
        <h3 id="modal-title">X√°c nh·∫≠n</h3>
        <p id="modal-msg" style="margin: 15px 0; color: #475569">
          B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën th·ª±c hi·ªán?
        </p>
        <div class="modal-buttons">
          <button class="btn btn-cancel" onclick="closeModal()">H·ªßy</button>
          <button class="btn btn-confirm" id="modal-confirm-btn">ƒê·ªìng √Ω</button>
        </div>
      </div>
    </div>

    <script>
      let DB = [];
      let state = {
        examId: null,
        currentQIdx: 0,
        answers: {},
        flags: [],
        timeLeft: 0,
        isFinished: false,
        isReviewing: false,
      };
      let timerInterval;

      async function loadDataAndInit() {
        try {
          const response = await fetch("data.json");
          if (!response.ok)
            throw new Error(`HTTP error! status: ${response.status}`);
          DB = await response.json();
          renderExamList();
          if (state.examId === null)
            document.getElementById("setup-screen").classList.add("hidden");
          checkLocalStorage();
        } catch (error) {
          console.error("L·ªói t·∫£i data:", error);
          document.getElementById("exam-list").innerHTML =
            `<p style="color:red; text-align:center;">L·ªói t·∫£i d·ªØ li·ªáu. H√£y ch·∫°y tr√™n Server.</p>`;
        }
      }
      window.onload = loadDataAndInit;

      window.onbeforeunload = (e) => {
        if (state.examId !== null && !state.isFinished && !state.isReviewing) {
          return "D·ªØ li·ªáu s·∫Ω b·ªã m·∫•t?";
        }
      };

      function renderExamList() {
        const list = document.getElementById("exam-list");
        list.innerHTML = "";
        if (DB.length === 0) {
          list.innerHTML = '<p style="text-align:center">Kh√¥ng c√≥ ƒë·ªÅ thi.</p>';
          return;
        }
        DB.forEach((exam, idx) => {
          const div = document.createElement("div");
          div.className = "exam-item";
          div.innerText = exam.title;
          div.onclick = () => trySelectExam(idx);
          div.id = `exam-btn-${idx}`;
          list.appendChild(div);
        });
      }

      // --- 1. H√ÄM T·∫†O ƒê·ªÄ NG·∫™U NHI√äN ---
      function createCustomExam() {
        // Ki·ªÉm tra n·∫øu ƒëang l√†m b√†i
        if (state.examId !== null && !state.isFinished) {
          showModal(
            "T·∫°o ƒë·ªÅ m·ªõi?",
            "B·∫°n ƒëang l√†m b√†i. N·∫øu t·∫°o ƒë·ªÅ m·ªõi, ti·∫øn ƒë·ªô hi·ªán t·∫°i s·∫Ω m·∫•t.",
            () => {
              generateRandomExam();
            },
          );
        } else {
          generateRandomExam();
        }
      }

      function generateRandomExam() {
        // 1. ƒê·ªãnh nghƒ©a danh s√°ch c√°c ID h·ª£p l·ªá ho·∫∑c quy t·∫Øc l·ªçc
        // C√°ch 1: N·∫øu ID trong data.json c·ªßa b·∫°n l√† "THADS_01", "THADS_02"...
        // C√°ch 2: N·∫øu ID l√† "DE_THADS_01" (nh∆∞ c√°c file tr∆∞·ªõc), ta s·∫Ω ki·ªÉm tra t·ª´ kh√≥a "THADS"

        let allQuestions = [];

        // Duy·ªát qua to√†n b·ªô c∆° s·ªü d·ªØ li·ªáu
        DB.forEach((exam) => {
          // --- B·ªò L·ªåC QUAN TR·ªåNG ---
          // Ch·ªâ l·∫•y nh·ªØng ƒë·ªÅ c√≥ ID ch·ª©a ch·ªØ "THADS" (ho·∫∑c b·∫°n c√≥ th·ªÉ li·ªát k√™ ch√≠nh x√°c c√°c ID)
          // V√≠ d·ª•: exam.id.startsWith("THADS_") ho·∫∑c exam.id.includes("THADS")
          if (exam.id && exam.id.toUpperCase().includes("THADS")) {
            // G√°n th√™m ngu·ªìn g·ªëc c√¢u h·ªèi ƒë·ªÉ tra c·ª©u n·∫øu c·∫ßn
            const questionsWithSource = exam.questions.map((q) => ({
              ...q,
              sourceExam: exam.title,
            }));

            allQuestions = allQuestions.concat(questionsWithSource);
          }
        });

        // Ki·ªÉm tra n·∫øu kh√¥ng t√¨m th·∫•y c√¢u h·ªèi n√†o
        if (allQuestions.length === 0) {
          alert(
            "Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu c·ªßa c√°c b·ªô ƒë·ªÅ THADS (01-10).\nVui l√≤ng ki·ªÉm tra l·∫°i file data.json xem ID ƒë√£ ƒë√∫ng ch∆∞a (v√≠ d·ª•: id: 'THADS_01').",
          );
          return;
        }

        // 2. Tr·ªôn ng·∫´u nhi√™n (Fisher-Yates Shuffle)
        for (let i = allQuestions.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [allQuestions[i], allQuestions[j]] = [
            allQuestions[j],
            allQuestions[i],
          ];
        }

        // 3. L·∫•y 60 c√¢u ƒë·∫ßu ti√™n
        // N·∫øu t·ªïng s·ªë c√¢u h·ªèi √≠t h∆°n 60, l·∫•y t·∫•t c·∫£ s·ªë c√¢u hi·ªán c√≥
        const questionCount = Math.min(allQuestions.length, 60);
        const selectedQuestions = allQuestions.slice(0, questionCount);

        // 4. T·∫°o Object ƒë·ªÅ thi m·ªõi
        const newExam = {
          id: `custom_thads_${Date.now()}`,
          title: `üìù ƒê·ªÅ T·ªïng H·ª£p Ng·∫´u Nhi√™n (${new Date().toLocaleTimeString()})`,
          questions: selectedQuestions,
        };

        // 5. Th√™m v√†o DB v√† render l·∫°i list
        DB.push(newExam);
        renderExamList();

        // 6. Ch·ªçn lu√¥n ƒë·ªÅ v·ª´a t·∫°o (l√† ph·∫ßn t·ª≠ cu·ªëi c√πng)
        selectExam(DB.length - 1);
      }

      function checkLocalStorage() {
        const saved = localStorage.getItem("quiz_state");
        if (saved) {
          const parsed = JSON.parse(saved);
          // Ki·ªÉm tra xem ƒë·ªÅ trong localStorage c√≥ c√≤n t·ªìn t·∫°i trong DB hi·ªán t·∫°i kh√¥ng
          if (DB[parsed.examId]) {
            if (!parsed.isFinished) {
              document
                .getElementById("resume-btn-container")
                .classList.remove("hidden");
              document
                .getElementById("setup-screen")
                .classList.remove("hidden");
            }
          } else {
            // N·∫øu ƒë·ªÅ kh√¥ng t·ªìn t·∫°i (do data thay ƒë·ªïi), x√≥a localstorage
            localStorage.removeItem("quiz_state");
          }
        }
      }

      function trySelectExam(idx) {
        if (
          state.examId !== null &&
          !state.isFinished &&
          state.examId !== idx
        ) {
          showModal("Chuy·ªÉn ƒë·ªÅ?", "Ti·∫øn ƒë·ªô hi·ªán t·∫°i s·∫Ω m·∫•t.", () =>
            selectExam(idx),
          );
        } else {
          selectExam(idx);
        }
      }

      function selectExam(idx) {
        localStorage.removeItem("quiz_state");
        state = {
          examId: idx,
          currentQIdx: 0,
          answers: {},
          flags: [],
          timeLeft: 0,
          isFinished: false,
          isReviewing: false,
        };

        document
          .querySelectorAll(".exam-item")
          .forEach((el) => el.classList.remove("active"));
        const btn = document.getElementById(`exam-btn-${idx}`);
        if (btn) btn.classList.add("active");

        document.getElementById("setup-screen").classList.remove("hidden");
        document.getElementById("quiz-interface").classList.add("hidden");
        document.getElementById("result-screen").classList.add("hidden");
        document.getElementById("setup-title").innerText = DB[idx].title;
        document.getElementById("resume-btn-container").classList.add("hidden");
      }

      function initQuiz() {
        const minutes = parseInt(document.getElementById("time-select").value);
        state.timeLeft = minutes * 60;
        startEngine();
      }

      function resumeQuiz() {
        const saved = localStorage.getItem("quiz_state");
        if (saved) {
          state = JSON.parse(saved);
          state.isReviewing = false;
          document
            .querySelectorAll(".exam-item")
            .forEach((el) => el.classList.remove("active"));
          const btn = document.getElementById(`exam-btn-${state.examId}`);
          if (btn) btn.classList.add("active");
          startEngine();
        }
      }

      function startEngine() {
        document.getElementById("setup-screen").classList.add("hidden");
        document.getElementById("result-screen").classList.add("hidden");
        document.getElementById("quiz-interface").classList.remove("hidden");
        document.getElementById("current-exam-title").innerText =
          DB[state.examId].title;

        document.getElementById("btn-submit").classList.remove("hidden");
        document.getElementById("btn-exit-review").classList.add("hidden");
        document.getElementById("timer").classList.remove("finished");
        document.getElementById("btn-flag").disabled = false;

        renderPalette();
        loadQuestion(state.currentQIdx);
        startTimer();
      }

      function loadQuestion(idx) {
        if (idx < 0 || idx >= DB[state.examId].questions.length) return;
        state.currentQIdx = idx;

        const q = DB[state.examId].questions[idx];
        document.getElementById("q-text").innerText =
          `C√¢u ${idx + 1}: ${q.question}`;
        document.getElementById("progress-text").innerText =
          `${idx + 1}/${DB[state.examId].questions.length}`;

        const optDiv = document.getElementById("q-options");
        optDiv.innerHTML = "";

        const userAns = state.answers[idx];
        const isAnswered = userAns !== undefined;
        const isReview = state.isFinished || state.isReviewing;

        q.options.forEach((optText, optIdx) => {
          const btn = document.createElement("button");
          btn.className = "option-btn";
          btn.innerText = optText;

          // N·∫øu ƒë√£ tr·∫£ l·ªùi (feedback t·ª©c th√¨) HO·∫∂C ƒëang xem l·∫°i
          if (isAnswered || isReview) {
            btn.disabled = true;

            // Logic m√†u s·∫Øc
            if (optIdx === q.correct) {
              btn.classList.add("correct");
            }
            if (
              userAns !== undefined &&
              optIdx === userAns &&
              optIdx !== q.correct
            ) {
              btn.classList.add("wrong");
            }
          } else {
            btn.onclick = () => handleAnswer(idx, optIdx);
          }
          optDiv.appendChild(btn);
        });

        // Hi·ªÉn th·ªã gi·∫£i th√≠ch
        const ratDiv = document.getElementById("q-rationale");
        // Hi·ªán gi·∫£i th√≠ch khi: ƒê√£ tr·∫£ l·ªùi (trong l√∫c thi) HO·∫∂C ƒêang xem l·∫°i (k·ªÉ c·∫£ ch∆∞a tr·∫£ l·ªùi)
        if (isAnswered || isReview) {
          ratDiv.style.display = "block";
          const statusText =
            userAns === undefined
              ? "<span style='color:orange'>(Ch∆∞a tr·∫£ l·ªùi)</span> "
              : "";
          ratDiv.innerHTML = `${statusText}<strong>Gi·∫£i th√≠ch:</strong> ${q.rationale}`;
        } else {
          ratDiv.style.display = "none";
        }

        document.getElementById("btn-prev").disabled = idx === 0;
        document.getElementById("btn-next").disabled =
          idx === DB[state.examId].questions.length - 1;

        updatePaletteUI();
        if (!isReview) saveState();
      }

      function handleAnswer(qIdx, ansIdx) {
        if (state.isFinished) return;
        state.answers[qIdx] = ansIdx;

        loadQuestion(qIdx); // Reload ƒë·ªÉ hi·ªán m√†u ngay
        updatePaletteUI();
        saveState();
      }

      function toggleFlag() {
        if (state.isFinished) return;
        const idx = state.currentQIdx;
        if (state.flags.includes(idx)) {
          state.flags = state.flags.filter((i) => i !== idx);
        } else {
          state.flags.push(idx);
        }
        updatePaletteUI();
        saveState();
      }

      function navStep(step) {
        loadQuestion(state.currentQIdx + step);
      }

      function renderPalette() {
        const grid = document.getElementById("palette");
        grid.innerHTML = "";
        const total = DB[state.examId].questions.length;
        for (let i = 0; i < total; i++) {
          const item = document.createElement("div");
          item.className = "p-item";
          item.innerText = i + 1;
          item.id = `p-${i}`;
          item.onclick = () => loadQuestion(i);
          grid.appendChild(item);
        }
        updatePaletteUI();
      }

      function updatePaletteUI() {
        const questions = DB[state.examId].questions;

        questions.forEach((q, i) => {
          const el = document.getElementById(`p-${i}`);
          if (!el) return;

          el.className = "p-item";

          // Active item
          if (i === state.currentQIdx) el.classList.add("active");

          // C·ªù
          if (state.flags.includes(i)) el.classList.add("is-flagged");

          // Logic m√†u s·∫Øc Palette: Hi·ªán ngay khi c√≥ c√¢u tr·∫£ l·ªùi
          if (state.answers[i] !== undefined) {
            const isCorrect = state.answers[i] === q.correct;
            el.classList.add(isCorrect ? "is-correct" : "is-wrong");
          }
        });
      }

      function startTimer() {
        clearInterval(timerInterval);
        if (state.timeLeft <= 0) {
          document.getElementById("timer").innerText = "‚àû";
          return;
        }
        if (state.isFinished) return;

        timerInterval = setInterval(() => {
          state.timeLeft--;
          const m = Math.floor(state.timeLeft / 60)
            .toString()
            .padStart(2, "0");
          const s = (state.timeLeft % 60).toString().padStart(2, "0");
          document.getElementById("timer").innerText = `${m}:${s}`;

          saveState();

          if (state.timeLeft <= 0) {
            clearInterval(timerInterval);
            alert("H·∫øt gi·ªù l√†m b√†i!");
            finishExam();
          }
        }, 1000);
      }

      function saveState() {
        if (!state.isFinished) {
          localStorage.setItem("quiz_state", JSON.stringify(state));
        }
      }

      function finishExam() {
        clearInterval(timerInterval);
        state.isFinished = true;
        localStorage.removeItem("quiz_state");

        let score = 0;
        let topicAnalysis = {};

        const questions = DB[state.examId].questions;
        questions.forEach((q, idx) => {
          if (!topicAnalysis[q.topic])
            topicAnalysis[q.topic] = { total: 0, wrong: 0 };
          topicAnalysis[q.topic].total++;

          if (state.answers[idx] === q.correct) {
            score++;
          } else {
            topicAnalysis[q.topic].wrong++;
          }
        });

        document.getElementById("quiz-interface").classList.add("hidden");
        document.getElementById("result-screen").classList.remove("hidden");
        document.getElementById("final-score").innerText =
          `${score}/${questions.length}`;

        let html = `<h3>Ph√¢n t√≠ch chi ti·∫øt:</h3><ul style="margin-top:10px; padding-left:20px;">`;
        let hasWeakness = false;

        for (const [topic, stat] of Object.entries(topicAnalysis)) {
          if (stat.wrong > 0) {
            hasWeakness = true;
            const percent = Math.round((stat.wrong / stat.total) * 100);
            html += `<li style="margin-bottom:8px;">
                        <strong>${topic}</strong>: Sai ${stat.wrong}/${stat.total} c√¢u (${percent}%). 
                        <span style="color:var(--danger)">C·∫ßn √¥n t·∫≠p th√™m.</span>
                    </li>`;
          }
        }
        if (!hasWeakness)
          html += `<li style="color:var(--success)">Tuy·ªát v·ªùi! B·∫°n kh√¥ng sai c√¢u n√†o theo ch·ªß ƒë·ªÅ.</li>`;
        html += `</ul>`;

        document.getElementById("analysis-box").innerHTML = html;
      }

      function enterReviewMode() {
        state.isReviewing = true;

        document.getElementById("result-screen").classList.add("hidden");
        document.getElementById("quiz-interface").classList.remove("hidden");

        document.getElementById("btn-submit").classList.add("hidden");
        document.getElementById("btn-exit-review").classList.remove("hidden");

        const timerEl = document.getElementById("timer");
        timerEl.innerText = "HO√ÄN TH√ÄNH";
        timerEl.classList.add("finished");

        document.getElementById("btn-flag").disabled = true;

        loadQuestion(0);
        updatePaletteUI();
      }

      function exitReviewMode() {
        state.isReviewing = false;
        document.getElementById("quiz-interface").classList.add("hidden");
        document.getElementById("result-screen").classList.remove("hidden");
      }

      // --- MODAL & CONFIRMATION ---
      let confirmCallback = null;

      function showModal(title, msg, callback) {
        document.getElementById("modal-title").innerText = title;
        document.getElementById("modal-msg").innerText = msg;
        document.getElementById("modal").style.display = "flex";
        confirmCallback = callback;
      }

      function closeModal() {
        document.getElementById("modal").style.display = "none";
        confirmCallback = null;
      }

      document.getElementById("modal-confirm-btn").onclick = () => {
        if (confirmCallback) confirmCallback();
        closeModal();
      };

      function confirmAction(action) {
        if (action === "submit") {
          const unanswered =
            DB[state.examId].questions.length -
            Object.keys(state.answers).length;
          let msg = "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën n·ªôp b√†i?";
          if (unanswered > 0) msg += ` B·∫°n c√≤n ${unanswered} c√¢u ch∆∞a l√†m.`;

          showModal("N·ªôp b√†i thi", msg, finishExam);
        } else if (action === "reset") {
          location.reload();
        }
      }
    </script>
  </body>
</html>
