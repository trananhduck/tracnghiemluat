<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>H·ªá Th·ªëng Tr·∫Øc Nghi·ªám THADS Pro</title>
    <style>
      :root {
        --primary: #2563eb;
        --success: #16a34a;
        --danger: #dc2626;
        --warning: #ca8a04;
        --info: #0ea5e9;
        --bg: #f3f4f6;
        --sidebar-width: 280px;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        display: flex;
        height: 100vh;
        background: var(--bg);
        overflow: hidden;
      }

      /* SIDEBAR TR√ÅI */
      aside.left-sidebar {
        width: var(--sidebar-width);
        background: #1e293b;
        color: white;
        display: flex;
        flex-direction: column;
        border-right: 1px solid #334155;
      }

      .sidebar-header {
        padding: 20px;
        font-size: 1.1rem;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 1px;
        border-bottom: 1px solid #334155;
        background: #0f172a;
      }

      .random-btn-container {
        padding: 15px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        border-bottom: 1px solid #334155;
      }

      .btn-random {
        width: 100%;
        padding: 12px;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.2s ease;
        font-size: 0.9rem;
      }

      .btn-gen-all {
        background: #8b5cf6;
      }
      .btn-gen-all:hover {
        background: #7c3aed;
      }

      .btn-gen-thads {
        background: var(--info);
      }
      .btn-gen-thads:hover {
        background: #0284c7;
      }

      .exam-list {
        overflow-y: auto;
        flex: 1;
      }

      .exam-item {
        padding: 15px 20px;
        cursor: pointer;
        transition: 0.2s;
        border-bottom: 1px solid #334155;
        font-size: 0.95rem;
      }

      .exam-item:hover {
        background: #334155;
      }
      .exam-item.active {
        background: var(--primary);
        border-left: 4px solid #60a5fa;
      }

      /* CH√çNH */
      main {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 25px;
        overflow-y: auto;
        position: relative;
      }

      .setup-screen,
      .result-screen {
        background: white;
        padding: 40px;
        border-radius: 12px;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        max-width: 700px;
        margin: auto;
        text-align: center;
      }

      .quiz-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: white;
        padding: 20px 30px;
        border-radius: 12px;
        margin-bottom: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      }

      .timer {
        font-size: 1.8rem;
        font-weight: 800;
        color: var(--danger);
        font-family: "Courier New", Courier, monospace;
      }

      .timer.finished {
        color: var(--success);
      }

      .question-card {
        background: white;
        padding: 35px;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 400px;
      }

      .q-text {
        font-size: 1.3rem;
        font-weight: 600;
        line-height: 1.5;
        margin-bottom: 30px;
        color: #1e293b;
      }

      .options-grid {
        display: grid;
        gap: 15px;
      }

      .option-btn {
        padding: 18px 25px;
        border: 2px solid #f1f5f9;
        border-radius: 10px;
        background: #f8fafc;
        text-align: left;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 1.05rem;
        color: #475569;
      }

      .option-btn:hover:not([disabled]) {
        border-color: var(--primary);
        background: #eff6ff;
        transform: translateX(5px);
      }

      .option-btn.correct {
        background: #dcfce7 !important;
        border-color: var(--success) !important;
        color: #14532d;
        font-weight: 700;
      }

      .option-btn.wrong {
        background: #fee2e2 !important;
        border-color: var(--danger) !important;
        color: #7f1d1d;
      }

      .rationale {
        margin-top: 25px;
        padding: 20px;
        background: #f0fdf4;
        border-left: 5px solid var(--success);
        border-radius: 8px;
        display: none;
        line-height: 1.6;
        animation: slideDown 0.4s ease;
      }

      .controls {
        margin-top: auto;
        padding-top: 30px;
        display: flex;
        justify-content: space-between;
        gap: 15px;
      }

      .btn {
        padding: 12px 25px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        color: white;
        transition: opacity 0.2s;
      }

      .btn-nav {
        background: var(--primary);
      }
      .btn-flag {
        background: var(--warning);
      }
      .btn-submit {
        background: var(--success);
      }
      .btn-review {
        background: #64748b;
      }

      /* PALETTE PH·∫¢I */
      aside.right-sidebar {
        width: 300px;
        background: white;
        border-left: 1px solid #e2e8f0;
        display: flex;
        flex-direction: column;
        padding: 20px;
      }

      .palette-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 10px;
        margin-top: 20px;
        overflow-y: auto;
      }

      .p-item {
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 600;
        position: relative;
      }

      .p-item.active {
        border: 2px solid var(--primary);
        box-shadow: 0 0 8px rgba(37, 99, 235, 0.3);
      }
      .p-item.is-correct {
        background: var(--success);
        color: white;
        border: none;
      }
      .p-item.is-wrong {
        background: var(--danger);
        color: white;
        border: none;
      }
      .p-item.is-flagged::after {
        content: "üö©";
        position: absolute;
        top: -8px;
        right: -5px;
        font-size: 12px;
      }

      /* MODAL */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(15, 23, 42, 0.7);
        z-index: 2000;
        display: none;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(4px);
      }

      .modal-box {
        background: white;
        padding: 30px;
        border-radius: 15px;
        width: 90%;
        max-width: 450px;
        text-align: center;
      }

      .hidden {
        display: none !important;
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @media (max-width: 1024px) {
        body {
          flex-direction: column;
          overflow: auto;
        }
        aside.left-sidebar,
        aside.right-sidebar {
          width: 100%;
          height: auto;
          max-height: 300px;
        }
        main {
          min-height: 80vh;
        }
      }
    </style>
  </head>
  <body>
    <aside class="left-sidebar">
      <div class="sidebar-header">üìë Ng√¢n H√†ng ƒê·ªÅ Thi</div>

      <div class="random-btn-container">
        <button class="btn-random btn-gen-all" onclick="createCustomExam()">
          üé≤ ƒê·ªÅ Ki·∫øn th·ª©c chung (60c)
        </button>
        <button class="btn-random btn-gen-thads" onclick="createTHADSExam()">
          ‚öñÔ∏è ƒê·ªÅ T·ªïng H·ª£p THADS (60c)
        </button>
      </div>

      <div class="exam-list" id="exam-list">
        <p style="padding: 20px; color: #94a3b8; text-align: center">
          ƒêang t·∫£i d·ªØ li·ªáu...
        </p>
      </div>
    </aside>

    <main>
      <div id="setup-screen" class="setup-screen hidden">
        <h2 id="setup-title" style="margin-bottom: 20px; color: var(--primary)">
          Ch·ªçn ƒê·ªÅ Thi
        </h2>
        <div
          style="
            background: #f8fafc;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
          "
        >
          <label style="display: block; margin-bottom: 10px; font-weight: 600"
            >Th·ªùi gian gi·ªõi h·∫°n:</label
          >
          <select
            id="time-select"
            style="
              padding: 12px;
              width: 100%;
              max-width: 250px;
              border-radius: 8px;
              border: 1px solid #cbd5e1;
            "
          >
            <option value="15">15 Ph√∫t (C·∫•p t·ªëc)</option>
            <option value="30">30 Ph√∫t (Ti√™u chu·∫©n)</option>
            <option value="45">45 Ph√∫t (Luy·ªán t·∫≠p)</option>
            <option value="60" selected>60 Ph√∫t (Thi th·∫≠t)</option>
            <option value="0">Kh√¥ng gi·ªõi h·∫°n th·ªùi gian</option>
          </select>
        </div>
        <button
          class="btn btn-nav"
          style="width: 100%; max-width: 300px; padding: 15px"
          onclick="initQuiz()"
        >
          B·∫ÆT ƒê·∫¶U L√ÄM B√ÄI
        </button>
        <div id="resume-btn-container" class="hidden" style="margin-top: 20px">
          <button class="btn btn-flag" onclick="resumeQuiz()">
            Ti·∫øp t·ª•c b√†i ƒëang l√†m d·ªü
          </button>
        </div>
      </div>

      <div
        id="quiz-interface"
        class="hidden"
        style="display: flex; flex-direction: column; height: 100%"
      >
        <div class="quiz-header">
          <div style="max-width: 70%">
            <h3
              id="current-exam-title"
              style="color: #0f172a; margin-bottom: 5px"
            >
              ƒê·ªÅ thi
            </h3>
            <span
              style="
                background: #e2e8f0;
                padding: 4px 10px;
                border-radius: 20px;
                font-size: 0.8rem;
                font-weight: bold;
              "
            >
              C√¢u: <span id="progress-text">0/60</span>
            </span>
          </div>
          <div class="timer" id="timer">00:00</div>
        </div>

        <div class="question-card">
          <div id="question-content">
            <p class="q-text" id="q-text">ƒêang t·∫£i c√¢u h·ªèi...</p>
            <div class="options-grid" id="q-options"></div>
            <div class="rationale" id="q-rationale"></div>
          </div>

          <div class="controls">
            <button class="btn btn-nav" id="btn-prev" onclick="navStep(-1)">
              ‚ùÆ Tr∆∞·ªõc
            </button>
            <button class="btn btn-flag" onclick="toggleFlag()" id="btn-flag">
              üö© ƒê√°nh d·∫•u
            </button>
            <button class="btn btn-nav" id="btn-next" onclick="navStep(1)">
              Sau ‚ùØ
            </button>
          </div>

          <div
            style="
              margin-top: 25px;
              border-top: 1px solid #f1f5f9;
              padding-top: 20px;
              display: flex;
              justify-content: flex-end;
            "
          >
            <button
              class="btn btn-submit"
              id="btn-submit"
              onclick="confirmAction('submit')"
            >
              N·ªòP B√ÄI
            </button>
            <button
              class="btn btn-review hidden"
              id="btn-exit-review"
              onclick="exitReviewMode()"
            >
              THO√ÅT XEM L·∫†I
            </button>
          </div>
        </div>
      </div>

      <div id="result-screen" class="result-screen hidden">
        <h1 style="color: var(--success); margin-bottom: 10px">
          Ho√†n Th√†nh B√†i Thi!
        </h1>
        <p
          id="result-exam-name"
          style="color: #64748b; margin-bottom: 20px"
        ></p>
        <div
          style="
            display: flex;
            justify-content: center;
            align-items: baseline;
            gap: 10px;
            margin: 30px 0;
          "
        >
          <span
            id="final-score"
            style="font-size: 5rem; font-weight: 800; color: var(--primary)"
            >0</span
          >
          <span id="total-q" style="font-size: 2rem; color: #94a3b8">/ 60</span>
        </div>
        <div id="analysis-box"></div>
        <div
          style="
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
          "
        >
          <button class="btn btn-review" onclick="enterReviewMode()">
            üîç XEM L·∫†I ƒê√ÅP √ÅN
          </button>
          <button class="btn btn-nav" onclick="confirmAction('reset')">
            üîÑ L√ÄM ƒê·ªÄ KH√ÅC
          </button>
        </div>
      </div>
    </main>

    <aside class="right-sidebar">
      <h4
        style="
          color: #1e293b;
          border-bottom: 2px solid #f1f5f9;
          padding-bottom: 10px;
        "
      >
        B·∫£n ƒë·ªì c√¢u h·ªèi
      </h4>
      <div class="palette-grid" id="palette"></div>
      <div
        style="
          margin-top: auto;
          padding: 15px;
          background: #f8fafc;
          border-radius: 10px;
          font-size: 0.8rem;
        "
      >
        <p style="margin-bottom: 5px">
          <span style="color: var(--success); font-size: 1.2rem">‚ñ†</span> C√¢u ƒë√£
          ch·ªçn
        </p>
        <p>
          <span style="color: var(--warning); font-size: 1.2rem">üö©</span> C·∫ßn
          xem l·∫°i
        </p>
      </div>
    </aside>

    <div id="modal" class="modal-overlay">
      <div class="modal-box">
        <h3 id="modal-title">X√°c nh·∫≠n</h3>
        <p
          id="modal-msg"
          style="margin: 20px 0; color: #475569; line-height: 1.5"
        ></p>
        <div style="display: flex; justify-content: center; gap: 12px">
          <button
            class="btn btn-review"
            style="background: #cbd5e1; color: #1e293b"
            onclick="closeModal()"
          >
            H·ªßy
          </button>
          <button
            class="btn btn-confirm"
            id="modal-confirm-btn"
            style="background: var(--primary)"
          >
            X√°c nh·∫≠n
          </button>
        </div>
      </div>
    </div>

    <script>
      let DB = [];
      let state = {
        examId: null,
        currentQIdx: 0,
        answers: {},
        flags: [],
        timeLeft: 0,
        isFinished: false,
        isReviewing: false,
      };
      let timerInterval;

      // --- T·∫¢I D·ªÆ LI·ªÜU ---
      async function loadDataAndInit() {
        try {
          const response = await fetch("data.json");
          if (!response.ok) throw new Error("Kh√¥ng th·ªÉ t·∫£i file data.json");
          DB = await response.json();
          renderExamList();
          checkLocalStorage();
        } catch (error) {
          console.error(error);
          document.getElementById("exam-list").innerHTML =
            `<p style="color:red; padding:20px;">L·ªói: ${error.message}</p>`;
        }
      }

      function checkLocalStorage() {
        const saved = localStorage.getItem("quiz_state");
        if (saved) {
          const parsed = JSON.parse(saved);
          if (DB[parsed.examId] && !parsed.isFinished) {
            document
              .getElementById("resume-btn-container")
              .classList.remove("hidden");
            document.getElementById("setup-screen").classList.remove("hidden");
          }
        }
      }

      function renderExamList() {
        const list = document.getElementById("exam-list");
        list.innerHTML = "";
        DB.forEach((exam, idx) => {
          const div = document.createElement("div");
          div.className = "exam-item";
          div.innerText = exam.title;
          div.onclick = () => trySelectExam(idx);
          div.id = `exam-btn-${idx}`;
          list.appendChild(div);
        });
      }

      // --- LOGIC T·∫†O ƒê·ªÄ ---
      function trySelectExam(idx) {
        if (
          state.examId !== null &&
          !state.isFinished &&
          state.examId !== idx
        ) {
          showModal("Chuy·ªÉn ƒë·ªÅ?", "Ti·∫øn ƒë·ªô hi·ªán t·∫°i s·∫Ω b·ªã x√≥a.", () =>
            selectExam(idx),
          );
        } else {
          selectExam(idx);
        }
      }

      function selectExam(idx) {
        localStorage.removeItem("quiz_state");
        state = {
          examId: idx,
          currentQIdx: 0,
          answers: {},
          flags: [],
          timeLeft: 0,
          isFinished: false,
          isReviewing: false,
        };

        document
          .querySelectorAll(".exam-item")
          .forEach((el) => el.classList.remove("active"));
        if (document.getElementById(`exam-btn-${idx}`))
          document.getElementById(`exam-btn-${idx}`).classList.add("active");

        document.getElementById("setup-screen").classList.remove("hidden");
        document.getElementById("quiz-interface").classList.add("hidden");
        document.getElementById("result-screen").classList.add("hidden");
        document.getElementById("setup-title").innerText = DB[idx].title;
        document.getElementById("resume-btn-container").classList.add("hidden");
      }

      // 1. ƒê·ªÅ ng·∫´u nhi√™n ho√†n to√†n
      function createCustomExam() {
        let allQ = [];
        DB.forEach((ex) => (allQ = allQ.concat(ex.questions)));
        const finalQ = allQ.sort(() => 0.5 - Math.random()).slice(0, 60);

        const newExam = {
          id: `rnd_${Date.now()}`,
          title: `üé≤ ƒê·ªÅ Ng·∫´u Nhi√™n (${new Date().toLocaleTimeString()})`,
          questions: finalQ,
        };
        DB.push(newExam);
        renderExamList();
        selectExam(DB.length - 1);
      }

      // 2. ƒê·ªÅ t·ªïng h·ª£p THADS (L·∫•y m·∫´u h·ªá th·ªëng theo t·ª∑ l·ªá)
      function createTHADSExam() {
        const thadsExams = DB.filter(
          (ex) => ex.id && ex.id.toUpperCase().includes("THADS"),
        );
        if (thadsExams.length === 0)
          return alert("Kh√¥ng t√¨m th·∫•y b·ªô ƒë·ªÅ TH_THADS n√†o!");

        let combinedQ = [];
        const perExam = Math.ceil(60 / thadsExams.length);

        thadsExams.forEach((ex) => {
          const picked = [...ex.questions]
            .sort(() => 0.5 - Math.random())
            .slice(0, perExam);
          combinedQ = combinedQ.concat(picked);
        });

        const finalQ = combinedQ.sort(() => 0.5 - Math.random()).slice(0, 60);
        const newExam = {
          id: `thads_mix_${Date.now()}`,
          title: `‚öñÔ∏è ƒê·ªÅ T·ªïng H·ª£p THADS (${new Date().toLocaleTimeString()})`,
          questions: finalQ,
        };
        DB.push(newExam);
        renderExamList();
        selectExam(DB.length - 1);
      }

      // --- V·∫¨N H√ÄNH ---
      function initQuiz() {
        const mins = parseInt(document.getElementById("time-select").value);
        state.timeLeft = mins * 60;
        startEngine();
      }

      function resumeQuiz() {
        state = JSON.parse(localStorage.getItem("quiz_state"));
        startEngine();
      }

      function startEngine() {
        document.getElementById("setup-screen").classList.add("hidden");
        document.getElementById("quiz-interface").classList.remove("hidden");
        document.getElementById("current-exam-title").innerText =
          DB[state.examId].title;
        renderPalette();
        loadQuestion(state.currentQIdx);
        startTimer();
      }

      function loadQuestion(idx) {
        state.currentQIdx = idx;
        const q = DB[state.examId].questions[idx];
        document.getElementById("q-text").innerText =
          `C√¢u ${idx + 1}: ${q.question}`;
        document.getElementById("progress-text").innerText =
          `${idx + 1}/${DB[state.examId].questions.length}`;

        const optDiv = document.getElementById("q-options");
        optDiv.innerHTML = "";

        const userAns = state.answers[idx];
        const isDone = userAns !== undefined;
        const isReview = state.isFinished || state.isReviewing;

        q.options.forEach((txt, i) => {
          const btn = document.createElement("button");
          btn.className = "option-btn";
          btn.innerText = txt;
          if (isDone || isReview) {
            btn.disabled = true;
            if (i === q.correct) btn.classList.add("correct");
            if (userAns === i && i !== q.correct) btn.classList.add("wrong");
          } else {
            btn.onclick = () => {
              state.answers[idx] = i;
              loadQuestion(idx);
            };
          }
          optDiv.appendChild(btn);
        });

        const rat = document.getElementById("q-rationale");
        if (isDone || isReview) {
          rat.style.display = "block";
          rat.innerHTML = `<strong>Gi·∫£i th√≠ch:</strong> ${q.rationale}`;
        } else {
          rat.style.display = "none";
        }

        document.getElementById("btn-prev").disabled = idx === 0;
        document.getElementById("btn-next").disabled =
          idx === DB[state.examId].questions.length - 1;
        updatePaletteUI();
        saveState();
      }

      function toggleFlag() {
        const idx = state.currentQIdx;
        state.flags.includes(idx)
          ? (state.flags = state.flags.filter((f) => f !== idx))
          : state.flags.push(idx);
        updatePaletteUI();
      }

      function navStep(step) {
        loadQuestion(state.currentQIdx + step);
      }

      function renderPalette() {
        const grid = document.getElementById("palette");
        grid.innerHTML = "";
        DB[state.examId].questions.forEach((_, i) => {
          const item = document.createElement("div");
          item.className = "p-item";
          item.innerText = i + 1;
          item.id = `p-${i}`;
          item.onclick = () => loadQuestion(i);
          grid.appendChild(item);
        });
      }

      function updatePaletteUI() {
        DB[state.examId].questions.forEach((q, i) => {
          const el = document.getElementById(`p-${i}`);
          if (!el) return;
          el.classList.remove("active", "is-correct", "is-wrong", "is-flagged");
          if (i === state.currentQIdx) el.classList.add("active");
          if (state.flags.includes(i)) el.classList.add("is-flagged");
          if (state.answers[i] !== undefined) {
            el.classList.add(
              state.answers[i] === q.correct ? "is-correct" : "is-wrong",
            );
          }
        });
      }

      function startTimer() {
        clearInterval(timerInterval);
        if (state.timeLeft <= 0) {
          document.getElementById("timer").innerText = "‚àû";
          return;
        }
        timerInterval = setInterval(() => {
          state.timeLeft--;
          const m = Math.floor(state.timeLeft / 60)
            .toString()
            .padStart(2, "0");
          const s = (state.timeLeft % 60).toString().padStart(2, "0");
          document.getElementById("timer").innerText = `${m}:${s}`;
          if (state.timeLeft <= 0) {
            clearInterval(timerInterval);
            finishExam();
          }
        }, 1000);
      }

      function saveState() {
        if (!state.isFinished)
          localStorage.setItem("quiz_state", JSON.stringify(state));
      }

      function finishExam() {
        state.isFinished = true;
        clearInterval(timerInterval);
        localStorage.removeItem("quiz_state");

        let score = 0;
        const qs = DB[state.examId].questions;
        qs.forEach((q, i) => {
          if (state.answers[i] === q.correct) score++;
        });

        document.getElementById("quiz-interface").classList.add("hidden");
        document.getElementById("result-screen").classList.remove("hidden");
        document.getElementById("final-score").innerText = score;
        document.getElementById("total-q").innerText = `/ ${qs.length}`;
        document.getElementById("result-exam-name").innerText =
          DB[state.examId].title;
      }

      function enterReviewMode() {
        state.isReviewing = true;
        document.getElementById("result-screen").classList.add("hidden");
        document.getElementById("quiz-interface").classList.remove("hidden");
        document.getElementById("btn-submit").classList.add("hidden");
        document.getElementById("btn-exit-review").classList.remove("hidden");
        document.getElementById("timer").innerText = "XEM L·∫†I";
        loadQuestion(0);
      }

      function exitReviewMode() {
        state.isReviewing = false;
        document.getElementById("quiz-interface").classList.add("hidden");
        document.getElementById("result-screen").classList.remove("hidden");
      }

      // --- MODAL ---
      let confirmCb = null;
      function showModal(title, msg, cb) {
        document.getElementById("modal-title").innerText = title;
        document.getElementById("modal-msg").innerText = msg;
        document.getElementById("modal").style.display = "flex";
        confirmCb = cb;
      }
      function closeModal() {
        document.getElementById("modal").style.display = "none";
      }
      document.getElementById("modal-confirm-btn").onclick = () => {
        if (confirmCb) confirmCb();
        closeModal();
      };

      function confirmAction(type) {
        if (type === "submit")
          showModal("N·ªôp b√†i?", "B·∫°n mu·ªën k·∫øt th√∫c b√†i thi?", finishExam);
        if (type === "reset") location.reload();
      }

      loadDataAndInit();
    </script>
  </body>
</html>
